<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const questionBox = document.getElementById("question-box");
  const questionText = document.getElementById("question-text");
  const optionsContainer = document.getElementById("options");

  let score = 0;
  let lives = 3;
  let gameRunning = false;
  let currentQuestionIndex = -1;
  let obstacle = null;
  let correctStreak = 0;

  const player = {
    x: 100,
    y: 300,
    width: 40,
    height: 20,
    vy: 0,
    gravity: 1.5,
    jumpStrength: -18,
    grounded: true,
    update() {
      this.vy += this.gravity;
      this.y += this.vy;
      if (this.y >= 300) {
        this.y = 300;
        this.vy = 0;
        this.grounded = true;
      }
    },
    jump() {
      if (this.grounded) {
        this.vy = this.jumpStrength;
        this.grounded = false;
      }
    },
    draw() {
      const stretch = this.vy < 0 ? 1.2 : this.vy > 5 ? 0.8 : 1;
      const h = this.height * stretch;
      const w = this.width * (2 - stretch);
      ctx.fillStyle = "#ff5722";
      ctx.fillRect(this.x, this.y + this.height - h, w, h);
    }
  };

  const questions = [
    { q: "What is the capital of France?", options: ["Paris", "Rome", "Berlin", "Madrid"], answer: "Paris" },
    { q: "What is 5 + 3?", options: ["8", "6", "9", "7"], answer: "8" },
    { q: "Who painted the Mona Lisa?", options: ["Leonardo da Vinci", "Vincent van Gogh", "Pablo Picasso", "Claude Monet"], answer: "Leonardo da Vinci" },
    { q: "What is the largest planet?", options: ["Jupiter", "Saturn", "Earth", "Mars"], answer: "Jupiter" },
    { q: "Who wrote 'Romeo and Juliet'?", options: ["William Shakespeare", "Charles Dickens", "Jane Austen", "Mark Twain"], answer: "William Shakespeare" },
    { q: "What is the square root of 16?", options: ["4", "8", "16", "2"], answer: "4" },
    { q: "Which gas do plants absorb from the air?", options: ["Carbon dioxide", "Oxygen", "Nitrogen", "Hydrogen"], answer: "Carbon dioxide" },
    { q: "What is the boiling point of water?", options: ["100°C", "90°C", "110°C", "120°C"], answer: "100°C" },
    { q: "What is the capital of Japan?", options: ["Tokyo", "Seoul", "Beijing", "Bangkok"], answer: "Tokyo" },
    { q: "What is the hardest natural substance?", options: ["Diamond", "Gold", "Iron", "Platinum"], answer: "Diamond" }
  ];

  function showQuestion() {
    const q = questions[++currentQuestionIndex % questions.length];
    questionBox.style.display = "block";
    questionText.textContent = q.q;
    optionsContainer.innerHTML = "";

    q.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.textContent = opt;
      btn.className = "option";
      btn.onclick = () => checkAnswer(opt, q.answer);
      optionsContainer.appendChild(btn);
    });
  }

  function checkAnswer(selected, correct) {
    questionBox.style.display = "none";
    if (selected === correct) {
      correctStreak++;
      if (correctStreak >= 3) {
        score += 100;
        correctStreak = 0;
      }
      score += 10;
      document.getElementById("score").textContent = score;
      player.jump(); // Jump immediately on correct answer
    } else {
      correctStreak = 0;
      loseLife();
    }

    setTimeout(spawnNextObstacleWithQuestion, 1000);
  }

  function spawnNextObstacleWithQuestion() {
    if (!gameRunning) return;
    spawnObstacle();
    showQuestion();
  }

  function spawnObstacle() {
    obstacle = {
      x: canvas.width,
      y: 320,
      width: 40,
      height: 80
    };
  }

  function updateObstacle() {
    if (!obstacle) return;
    obstacle.x -= 3;

    // Collision check
    if (
      obstacle.x < player.x + player.width &&
      obstacle.x + obstacle.width > player.x &&
      player.y + player.height > obstacle.y
    ) {
      obstacle = null;
      loseLife();
    }

    if (obstacle && obstacle.x + obstacle.width < 0) {
      obstacle = null;
    }
  }

  function drawObstacle() {
    if (obstacle) {
      ctx.fillStyle = "#333";
      ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
    }
  }

  function flashCollision() {
    canvas.classList.add("flash");
    setTimeout(() => canvas.classList.remove("flash"), 300);
  }

  function loseLife() {
    if (!gameRunning) return;
    lives--;
    document.getElementById("lives").textContent = lives;
    flashCollision();
    if (lives <= 0) {
      endGame();
    }
  }

  function endGame() {
    gameRunning = false;
    document.getElementById("final-score").textContent = score;
    document.getElementById("game-over-box").style.display = "block";
  }

  function gameLoop() {
    if (!gameRunning) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    player.update();
    player.draw();
    updateObstacle();
    drawObstacle();

    requestAnimationFrame(gameLoop);
  }

  document.getElementById("start-btn").addEventListener("click", () => {
    document.getElementById("start-screen").style.display = "none";
    gameRunning = true;
    score = 0;
    lives = 3;
    document.getElementById("score").textContent = score;
    document.getElementById("lives").textContent = lives;

    spawnNextObstacleWithQuestion();
    gameLoop();
  });
</script>
